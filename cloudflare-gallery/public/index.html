<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DreamGen Gallery - AI Image Generation</title>
  <meta name="description" content="DreamGen - Automated AI image generation powered by Flux and Ollama. Browse generated artworks organized by week.">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: #0a0a0a;
      min-height: 100vh;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      color: #e5e5e5;
    }

    /* Header */
    .header {
      border-bottom: 1px solid #222;
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .logo-icon {
      width: 28px;
      height: 28px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      border-radius: 6px;
    }
    .logo-text {
      font-size: 16px;
      font-weight: 700;
      letter-spacing: 2px;
      color: #a78bfa;
    }
    .nav-links {
      display: flex;
      gap: 20px;
    }
    .nav-links a {
      color: #888;
      text-decoration: none;
      font-size: 13px;
      transition: color 0.2s;
    }
    .nav-links a:hover {
      color: #a78bfa;
    }

    /* Hero Section */
    .hero {
      padding: 60px 24px;
      text-align: center;
      border-bottom: 1px solid #222;
    }
    .hero h1 {
      font-size: 32px;
      font-weight: 300;
      margin-bottom: 16px;
      color: #fff;
    }
    .hero h1 span {
      background: linear-gradient(135deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .hero p {
      color: #888;
      font-size: 15px;
      max-width: 600px;
      margin: 0 auto 24px;
      line-height: 1.6;
    }
    .hero-stats {
      display: flex;
      justify-content: center;
      gap: 40px;
      margin-top: 32px;
    }
    .stat {
      text-align: center;
    }
    .stat-value {
      font-size: 28px;
      font-weight: 600;
      color: #a78bfa;
    }
    .stat-label {
      font-size: 12px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-top: 4px;
    }

    /* View Modes */
    .view-controls {
      padding: 16px 24px;
      border-bottom: 1px solid #222;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .view-toggle {
      display: flex;
      background: #1a1a1a;
      border-radius: 6px;
      padding: 4px;
    }
    .view-btn {
      padding: 8px 16px;
      border: none;
      background: transparent;
      color: #888;
      font-size: 13px;
      cursor: pointer;
      border-radius: 4px;
      transition: all 0.2s;
    }
    .view-btn.active {
      background: #2a2a2a;
      color: #fff;
    }
    .view-btn:hover:not(.active) {
      color: #ccc;
    }

    /* Main Content */
    .main {
      padding: 24px;
    }

    /* Week Groups */
    .week-group {
      margin-bottom: 24px;
      border: 1px solid #222;
      border-radius: 8px;
      overflow: hidden;
    }
    .week-header {
      padding: 16px 20px;
      background: #111;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.2s;
    }
    .week-header:hover {
      background: #1a1a1a;
    }
    .week-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .week-arrow {
      color: #666;
      transition: transform 0.2s;
    }
    .week-group.expanded .week-arrow {
      transform: rotate(90deg);
    }
    .week-title {
      font-size: 14px;
      font-weight: 600;
      color: #fff;
    }
    .week-subtitle {
      font-size: 12px;
      color: #666;
      margin-top: 2px;
    }
    .week-previews {
      display: flex;
      gap: -8px;
    }
    .week-preview {
      width: 32px;
      height: 32px;
      border-radius: 4px;
      border: 2px solid #0a0a0a;
      object-fit: cover;
      margin-left: -8px;
    }
    .week-preview:first-child {
      margin-left: 0;
    }
    .week-count {
      width: 32px;
      height: 32px;
      border-radius: 4px;
      background: #222;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      color: #888;
      margin-left: -8px;
    }
    .week-content {
      display: none;
      padding: 16px;
    }
    .week-group.expanded .week-content {
      display: block;
    }

    /* Image Grid */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 12px;
    }
    .grid-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      background: #111;
    }
    .grid-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s;
    }
    .grid-item:hover img {
      transform: scale(1.05);
    }

    /* Slideshow View */
    .slideshow {
      display: none;
    }
    .slideshow.active {
      display: block;
    }
    .gallery {
      position: relative;
      width: 90vw;
      max-width: 1200px;
      height: 70vh;
      margin: 0 auto;
    }
    .gallery img {
      position: absolute;
      width: 100%;
      height: 100%;
      object-fit: contain;
      opacity: 0;
      transition: opacity 1.5s ease-in-out;
    }
    .gallery img.active { opacity: 1; }

    .controls {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 24px;
    }
    .controls button {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      color: #888;
      padding: 10px 20px;
      cursor: pointer;
      border-radius: 4px;
      transition: all 0.2s;
    }
    .controls button:hover {
      background: rgba(255,255,255,0.2);
      color: #fff;
    }
    .progress {
      position: fixed;
      top: 0;
      left: 0;
      height: 2px;
      background: linear-gradient(90deg, #667eea, #764ba2);
      transition: width 0.1s linear;
    }

    .info {
      text-align: center;
      margin-top: 16px;
      color: #444;
      font-size: 14px;
      font-family: monospace;
    }
    .info-date {
      color: #666;
      font-size: 13px;
      margin-top: 4px;
    }

    .loading {
      color: #666;
      font-size: 18px;
      text-align: center;
      padding: 60px;
    }

    /* Footer */
    .footer {
      border-top: 1px solid #222;
      padding: 32px 24px;
      text-align: center;
    }
    .footer-links {
      display: flex;
      justify-content: center;
      gap: 24px;
      margin-bottom: 16px;
    }
    .footer-links a {
      color: #888;
      text-decoration: none;
      font-size: 13px;
      transition: color 0.2s;
    }
    .footer-links a:hover {
      color: #a78bfa;
    }
    .footer-credit {
      color: #444;
      font-size: 12px;
    }
    .footer-credit a {
      color: #667eea;
      text-decoration: none;
    }

    @media (max-width: 640px) {
      .hero h1 { font-size: 24px; }
      .hero-stats { gap: 20px; }
      .stat-value { font-size: 22px; }
      .nav-links { display: none; }
      .grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>
<body>
  <div class="progress" id="progress"></div>

  <header class="header">
    <div class="logo">
      <div class="logo-icon"></div>
      <span class="logo-text">DREAMGEN</span>
    </div>
    <nav class="nav-links">
      <a href="https://github.com/vaskin/dreamgen" target="_blank">GitHub</a>
      <a href="https://agenticinsights.com" target="_blank">Agentic Insights</a>
    </nav>
  </header>

  <section class="hero">
    <h1>AI-Generated <span>Art Gallery</span></h1>
    <p>
      Automated image generation powered by Flux diffusion models and Ollama.
      New images are generated continuously with creative prompts from AI.
    </p>
    <div class="hero-stats">
      <div class="stat">
        <div class="stat-value" id="total-images">-</div>
        <div class="stat-label">Images</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="total-weeks">-</div>
        <div class="stat-label">Weeks</div>
      </div>
    </div>
  </section>

  <div class="view-controls">
    <div class="view-toggle">
      <button class="view-btn active" data-view="week">By Week</button>
      <button class="view-btn" data-view="slideshow">Slideshow</button>
    </div>
  </div>

  <main class="main" id="main">
    <div id="week-view"></div>
    <div class="slideshow" id="slideshow-view">
      <div class="gallery" id="gallery">
        <div class="loading" id="loading">Loading gallery...</div>
      </div>
      <div class="controls">
        <button id="prev">&#8592; Prev</button>
        <button id="pause">Pause</button>
        <button id="next">Next &#8594;</button>
      </div>
      <div class="info" id="info"></div>
    </div>
  </main>

  <footer class="footer">
    <div class="footer-links">
      <a href="https://github.com/vaskin/dreamgen">Source Code</a>
      <a href="https://github.com/vaskin/dreamgen/issues">Report Issue</a>
    </div>
    <div class="footer-credit">
      Built with Flux + Ollama by <a href="https://agenticinsights.com">Agentic Insights</a>
    </div>
  </footer>

  <script>
    let imagesList = [];
    let images = [];
    let current = 0;
    let interval = null;
    let paused = false;
    let progressInterval = null;
    let currentView = 'week';
    const ROTATE_TIME = 8000;

    async function init() {
      try {
        const res = await fetch('/api/images');
        imagesList = await res.json();

        document.getElementById('total-images').textContent = imagesList.length;

        if (imagesList.length === 0) {
          document.getElementById('loading').textContent = 'No images yet';
          document.getElementById('week-view').innerHTML = '<div class="loading">No images generated yet</div>';
          return;
        }

        // Organize by week
        const weekGroups = organizeByWeek(imagesList);
        document.getElementById('total-weeks').textContent = weekGroups.length;
        renderWeekView(weekGroups);

        // Setup slideshow
        setupSlideshow();

        // View toggle
        document.querySelectorAll('.view-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentView = btn.dataset.view;
            updateView();
          });
        });

      } catch (error) {
        document.getElementById('loading').textContent = 'Error loading gallery';
        document.getElementById('week-view').innerHTML = '<div class="loading">Error loading gallery</div>';
        console.error(error);
      }
    }

    function organizeByWeek(images) {
      const groups = new Map();

      images.forEach(item => {
        const date = parseDate(item.key);
        if (!date) return;

        const year = date.getFullYear();
        const week = getWeekNumber(date);
        const key = `${year}-${week}`;

        if (!groups.has(key)) {
          const { start, end } = getWeekBounds(year, week);
          groups.set(key, {
            year,
            week,
            startDate: start,
            endDate: end,
            images: []
          });
        }
        groups.get(key).images.push(item);
      });

      return Array.from(groups.values()).sort((a, b) => {
        if (a.year !== b.year) return b.year - a.year;
        return b.week - a.week;
      });
    }

    function parseDate(filename) {
      const match = filename.match(/(\d{4})(\d{2})(\d{2})/);
      if (!match) return null;
      return new Date(match[1], parseInt(match[2]) - 1, match[3]);
    }

    function getWeekNumber(date) {
      const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
      const dayNum = d.getUTCDay() || 7;
      d.setUTCDate(d.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
      return Math.ceil((((d.getTime() - yearStart.getTime()) / 86400000) + 1) / 7);
    }

    function getWeekBounds(year, week) {
      const jan1 = new Date(year, 0, 1);
      const daysToMonday = (jan1.getDay() === 0 ? 6 : jan1.getDay() - 1);
      const firstMonday = new Date(year, 0, 1 - daysToMonday);

      const start = new Date(firstMonday);
      start.setDate(start.getDate() + (week - 1) * 7);

      const end = new Date(start);
      end.setDate(end.getDate() + 6);

      return { start, end };
    }

    function formatDateRange(start, end) {
      const opts = { month: 'short', day: 'numeric' };
      return `${start.toLocaleDateString('en-US', opts)} - ${end.toLocaleDateString('en-US', opts)}`;
    }

    function renderWeekView(weekGroups) {
      const container = document.getElementById('week-view');
      container.innerHTML = weekGroups.map((group, idx) => `
        <div class="week-group ${idx === 0 ? 'expanded' : ''}" data-week="${group.year}-${group.week}">
          <div class="week-header" onclick="toggleWeek('${group.year}-${group.week}')">
            <div class="week-info">
              <span class="week-arrow">&#9654;</span>
              <div>
                <div class="week-title">Week ${group.week}, ${group.year}</div>
                <div class="week-subtitle">${formatDateRange(group.startDate, group.endDate)} &bull; ${group.images.length} images</div>
              </div>
            </div>
            <div class="week-previews">
              ${group.images.slice(0, 3).map(img => `
                <img class="week-preview" src="/api/images/${img.key}" alt="" loading="lazy">
              `).join('')}
              ${group.images.length > 3 ? `<div class="week-count">+${group.images.length - 3}</div>` : ''}
            </div>
          </div>
          <div class="week-content">
            <div class="grid">
              ${group.images.map(img => `
                <div class="grid-item" onclick="openImage('${img.key}')">
                  <img src="/api/images/${img.key}" alt="" loading="lazy">
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      `).join('');
    }

    function toggleWeek(weekKey) {
      const group = document.querySelector(`[data-week="${weekKey}"]`);
      group.classList.toggle('expanded');
    }

    function openImage(key) {
      window.open(`/api/images/${key}`, '_blank');
    }

    function updateView() {
      document.getElementById('week-view').style.display = currentView === 'week' ? 'block' : 'none';
      document.getElementById('slideshow-view').classList.toggle('active', currentView === 'slideshow');
    }

    function setupSlideshow() {
      const gallery = document.getElementById('gallery');
      document.getElementById('loading').style.display = 'none';

      const shuffled = [...imagesList].sort(() => Math.random() - 0.5);

      shuffled.forEach((item, i) => {
        const img = document.createElement('img');
        img.src = `/api/images/${item.key}`;
        img.dataset.date = item.dateStr;
        img.loading = 'lazy';
        if (i === 0) img.classList.add('active');
        gallery.appendChild(img);
        images.push(img);
      });

      updateInfo();
      startRotation();
      startProgress();

      document.addEventListener('keydown', (e) => {
        if (currentView !== 'slideshow') return;
        if (e.key === 'ArrowLeft') prev();
        if (e.key === 'ArrowRight') next();
        if (e.key === ' ') togglePause();
      });
    }

    function updateInfo() {
      const currentImg = images[current];
      const date = currentImg?.dataset?.date || '';
      const countText = `${current + 1} / ${images.length}`;
      let infoHtml = countText;
      if (date) {
        infoHtml += `<div class="info-date">${date}</div>`;
      }
      document.getElementById('info').innerHTML = infoHtml;
    }

    function startProgress() {
      let elapsed = 0;
      const progressBar = document.getElementById('progress');
      progressInterval = setInterval(() => {
        if (!paused && currentView === 'slideshow') {
          elapsed += 50;
          progressBar.style.width = `${(elapsed / ROTATE_TIME) * 100}%`;
          if (elapsed >= ROTATE_TIME) elapsed = 0;
        }
      }, 50);
    }

    function rotate() {
      images[current].classList.remove('active');
      current = (current + 1) % images.length;
      images[current].classList.add('active');
      updateInfo();
      document.getElementById('progress').style.width = '0%';
    }

    function startRotation() {
      interval = setInterval(() => {
        if (!paused && currentView === 'slideshow') rotate();
      }, ROTATE_TIME);
    }

    function next() { rotate(); }

    function prev() {
      images[current].classList.remove('active');
      current = (current - 1 + images.length) % images.length;
      images[current].classList.add('active');
      updateInfo();
      document.getElementById('progress').style.width = '0%';
    }

    function togglePause() {
      paused = !paused;
      document.getElementById('pause').textContent = paused ? 'Play' : 'Pause';
    }

    document.getElementById('prev').addEventListener('click', prev);
    document.getElementById('next').addEventListener('click', next);
    document.getElementById('pause').addEventListener('click', togglePause);

    init();
  </script>
</body>
</html>
