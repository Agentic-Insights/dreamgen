<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DreamGen</title>
  <meta name="description" content="DreamGen - AI-generated art gallery powered by Flux and Z-Image diffusion models">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400&family=JetBrains+Mono:wght@300&display=swap" rel="stylesheet">
  <style>
    :root {
      --void: #000;
      --whisper: rgba(255,255,255,0.08);
      --ghost: rgba(255,255,255,0.25);
      --mist: rgba(255,255,255,0.5);
      --light: rgba(255,255,255,0.85);
      --accent: #8b7cf7;
      --font-display: 'Cormorant Garamond', Georgia, serif;
      --font-mono: 'JetBrains Mono', monospace;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
      height: 100%;
      overflow: hidden;
    }

    body {
      background: var(--void);
      font-family: var(--font-display);
      color: var(--light);
      cursor: none;
    }

    /* Custom cursor */
    .cursor {
      position: fixed;
      width: 8px;
      height: 8px;
      background: var(--accent);
      border-radius: 50%;
      pointer-events: none;
      z-index: 9999;
      mix-blend-mode: difference;
      transition: transform 0.15s ease-out;
    }
    .cursor.expanded {
      transform: scale(3);
      opacity: 0.5;
    }

    /* Progress bar - ultra thin */
    .progress {
      position: fixed;
      top: 0;
      left: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--accent), transparent);
      z-index: 100;
      opacity: 0.6;
    }

    /* Gallery container */
    .gallery {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .gallery img {
      position: absolute;
      max-width: 92vw;
      max-height: 92vh;
      object-fit: contain;
      opacity: 0;
      transform: scale(0.98);
      transition: opacity 1.2s cubic-bezier(0.4, 0, 0.2, 1),
                  transform 1.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .gallery img.active {
      opacity: 1;
      transform: scale(1);
    }

    /* Title - top left, always visible but subtle */
    .title {
      position: fixed;
      top: 24px;
      left: 28px;
      z-index: 50;
      opacity: 0.4;
      transition: opacity 0.4s;
    }
    .title:hover {
      opacity: 1;
    }
    .title h1 {
      font-size: 13px;
      font-weight: 300;
      letter-spacing: 4px;
      text-transform: uppercase;
      color: var(--light);
    }
    .title a {
      color: inherit;
      text-decoration: none;
    }

    /* Counter - bottom left */
    .counter {
      position: fixed;
      bottom: 24px;
      left: 28px;
      font-family: var(--font-mono);
      font-size: 11px;
      font-weight: 300;
      letter-spacing: 1px;
      color: var(--ghost);
      z-index: 50;
    }

    /* Info panel - slides in from right */
    .info-toggle {
      position: fixed;
      top: 24px;
      right: 28px;
      width: 32px;
      height: 32px;
      background: transparent;
      border: 1px solid var(--whisper);
      border-radius: 50%;
      cursor: pointer;
      z-index: 60;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
      opacity: 0.4;
    }
    .info-toggle:hover {
      border-color: var(--ghost);
      opacity: 1;
    }
    .info-toggle svg {
      width: 14px;
      height: 14px;
      stroke: var(--mist);
      stroke-width: 1.5;
      fill: none;
    }
    .info-toggle.active {
      background: var(--whisper);
      opacity: 1;
    }

    .info-panel {
      position: fixed;
      top: 0;
      right: 0;
      width: 320px;
      height: 100%;
      background: rgba(0,0,0,0.92);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-left: 1px solid var(--whisper);
      transform: translateX(100%);
      transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 55;
      padding: 80px 32px 32px;
    }
    .info-panel.open {
      transform: translateX(0);
    }

    .info-section {
      margin-bottom: 40px;
    }
    .info-label {
      font-family: var(--font-mono);
      font-size: 9px;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--ghost);
      margin-bottom: 12px;
    }
    .info-title {
      font-size: 28px;
      font-weight: 300;
      line-height: 1.2;
      margin-bottom: 16px;
    }
    .info-desc {
      font-size: 14px;
      font-weight: 300;
      line-height: 1.7;
      color: var(--mist);
    }

    .info-links {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .info-link {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      background: var(--whisper);
      border: 1px solid transparent;
      text-decoration: none;
      color: var(--mist);
      font-family: var(--font-mono);
      font-size: 11px;
      letter-spacing: 1px;
      transition: all 0.3s;
    }
    .info-link:hover {
      border-color: var(--ghost);
      color: var(--light);
    }
    .info-link svg {
      width: 16px;
      height: 16px;
      stroke: currentColor;
      stroke-width: 1.5;
      fill: none;
    }

    .info-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    .stat {
      padding: 16px;
      background: var(--whisper);
    }
    .stat-value {
      font-size: 24px;
      font-weight: 300;
      color: var(--light);
    }
    .stat-label {
      font-family: var(--font-mono);
      font-size: 9px;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: var(--ghost);
      margin-top: 4px;
    }

    /* Controls - bottom center, appear on hover */
    .controls {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 2px;
      opacity: 0;
      transition: opacity 0.4s;
      z-index: 50;
    }
    body:hover .controls,
    .controls:focus-within {
      opacity: 1;
    }

    .ctrl-btn {
      width: 40px;
      height: 40px;
      background: transparent;
      border: 1px solid var(--whisper);
      color: var(--ghost);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .ctrl-btn:first-child {
      border-radius: 4px 0 0 4px;
    }
    .ctrl-btn:last-child {
      border-radius: 0 4px 4px 0;
    }
    .ctrl-btn:hover {
      background: var(--whisper);
      border-color: var(--ghost);
      color: var(--light);
    }
    .ctrl-btn svg {
      width: 16px;
      height: 16px;
      stroke: currentColor;
      stroke-width: 1.5;
      fill: none;
    }

    /* Metadata display - bottom right */
    .metadata {
      position: fixed;
      bottom: 24px;
      right: 28px;
      text-align: right;
      font-family: var(--font-mono);
      font-size: 11px;
      font-weight: 300;
      letter-spacing: 1px;
      color: var(--ghost);
      z-index: 50;
      opacity: 0;
      transition: opacity 0.4s;
      max-width: 300px;
    }
    body:hover .metadata {
      opacity: 1;
    }
    .metadata-date {
      color: var(--mist);
      margin-bottom: 4px;
    }
    .metadata-model {
      font-size: 9px;
      color: var(--ghost);
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    /* Caption overlay - appears on click/tap */
    .caption-overlay {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(transparent, rgba(0,0,0,0.95));
      padding: 80px 28px 28px;
      z-index: 45;
      transform: translateY(100%);
      transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .caption-overlay.visible {
      transform: translateY(0);
    }
    .caption-text {
      font-family: var(--font-display);
      font-size: 16px;
      font-weight: 300;
      line-height: 1.6;
      color: var(--light);
      max-width: 800px;
      margin: 0 auto;
      text-align: center;
    }
    .caption-hint {
      position: fixed;
      bottom: 70px;
      right: 28px;
      font-family: var(--font-mono);
      font-size: 9px;
      letter-spacing: 1px;
      color: var(--ghost);
      opacity: 0;
      transition: opacity 0.4s;
      z-index: 50;
    }
    body:hover .caption-hint {
      opacity: 0.5;
    }

    /* Loading state */
    .loading {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: var(--font-mono);
      font-size: 11px;
      letter-spacing: 2px;
      color: var(--ghost);
    }
    .loading.hidden {
      opacity: 0;
      pointer-events: none;
    }

    /* Keyboard hints */
    .hints {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 24px;
      font-family: var(--font-mono);
      font-size: 9px;
      letter-spacing: 1px;
      color: var(--ghost);
      opacity: 0;
      transition: opacity 0.4s;
      z-index: 50;
    }
    body:hover .hints {
      opacity: 0.6;
    }
    .hint kbd {
      display: inline-block;
      padding: 2px 6px;
      background: var(--whisper);
      border-radius: 2px;
      margin-right: 6px;
    }

    /* Mobile adjustments */
    @media (max-width: 768px) {
      body { cursor: auto; }
      .cursor { display: none; }
      .hints { display: none; }
      .controls { opacity: 1; }
      .metadata { opacity: 1; }
      .caption-hint { opacity: 0.5; }
      .info-panel { width: 100%; }
      .title { opacity: 0.6; }
    }

    /* Fade in animation */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .fade-in {
      animation: fadeIn 1s ease-out forwards;
    }
  </style>
</head>
<body>
  <div class="cursor" id="cursor"></div>
  <div class="progress" id="progress"></div>

  <div class="title">
    <h1><a href="https://agenticinsights.com/code" target="_blank">DreamGen</a></h1>
  </div>

  <button class="info-toggle" id="infoToggle" aria-label="Toggle info panel">
    <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg>
  </button>

  <div class="info-panel" id="infoPanel">
    <div class="info-section">
      <div class="info-label">Project</div>
      <h2 class="info-title">DreamGen</h2>
      <p class="info-desc">
        Autonomous AI image generation powered by Flux and Z-Image diffusion models.
        Creative prompts crafted by Ollama. Continuous generation with evolving art styles.
      </p>
    </div>

    <div class="info-section">
      <div class="info-label">Statistics</div>
      <div class="info-stats">
        <div class="stat">
          <div class="stat-value" id="totalImages">—</div>
          <div class="stat-label">Images</div>
        </div>
        <div class="stat">
          <div class="stat-value" id="totalDays">—</div>
          <div class="stat-label">Days</div>
        </div>
      </div>
    </div>

    <div class="info-section">
      <div class="info-label">Links</div>
      <div class="info-links">
        <a href="https://github.com/Agentic-Insights/dreamgen" target="_blank" class="info-link">
          <svg viewBox="0 0 24 24"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/></svg>
          Source Code
        </a>
        <a href="https://agenticinsights.com/code" target="_blank" class="info-link">
          <svg viewBox="0 0 24 24"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>
          Code Artifacts
        </a>
        <a href="https://agenticinsights.com" target="_blank" class="info-link">
          <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
          Agentic Insights
        </a>
      </div>
    </div>
  </div>

  <div class="gallery" id="gallery">
    <div class="loading" id="loading">Loading</div>
  </div>

  <div class="counter" id="counter"></div>

  <div class="controls">
    <button class="ctrl-btn" id="prev" aria-label="Previous">
      <svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg>
    </button>
    <button class="ctrl-btn" id="pause" aria-label="Pause">
      <svg viewBox="0 0 24 24" id="pauseIcon"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>
    </button>
    <button class="ctrl-btn" id="next" aria-label="Next">
      <svg viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></svg>
    </button>
  </div>

  <div class="hints">
    <span class="hint"><kbd>←</kbd><kbd>→</kbd> Navigate</span>
    <span class="hint"><kbd>Space</kbd> Pause</span>
    <span class="hint"><kbd>C</kbd> Caption</span>
  </div>

  <div class="caption-hint" id="captionHint">tap for caption</div>

  <div class="metadata" id="metadata">
    <div class="metadata-date" id="metaDate"></div>
    <div class="metadata-model" id="metaModel">Flux Schnell</div>
  </div>

  <div class="caption-overlay" id="captionOverlay">
    <div class="caption-text" id="captionText"></div>
  </div>

  <script>
    // State
    let images = [];
    let imageData = [];
    let captions = {};
    let current = 0;
    let paused = false;
    let captionVisible = false;
    let rotateInterval = null;
    let progressInterval = null;
    const ROTATE_TIME = 8000;

    // Custom cursor
    const cursor = document.getElementById('cursor');
    document.addEventListener('mousemove', e => {
      cursor.style.left = e.clientX - 4 + 'px';
      cursor.style.top = e.clientY - 4 + 'px';
    });
    document.querySelectorAll('button, a').forEach(el => {
      el.addEventListener('mouseenter', () => cursor.classList.add('expanded'));
      el.addEventListener('mouseleave', () => cursor.classList.remove('expanded'));
    });

    // Info panel toggle
    const infoToggle = document.getElementById('infoToggle');
    const infoPanel = document.getElementById('infoPanel');
    infoToggle.addEventListener('click', () => {
      infoPanel.classList.toggle('open');
      infoToggle.classList.toggle('active');
    });

    // Init
    async function init() {
      try {
        const res = await fetch('/api/images');
        const imagesList = await res.json();

        if (imagesList.length === 0) {
          document.getElementById('loading').textContent = 'No images yet';
          return;
        }

        // Stats
        document.getElementById('totalImages').textContent = imagesList.length;
        const dates = imagesList.map(i => parseDate(i.key)).filter(Boolean);
        const uniqueDays = new Set(dates.map(d => d.toDateString())).size;
        document.getElementById('totalDays').textContent = uniqueDays;

        // Shuffle and load images
        const shuffled = [...imagesList].sort(() => Math.random() - 0.5);
        imageData = shuffled;
        const gallery = document.getElementById('gallery');
        document.getElementById('loading').classList.add('hidden');

        shuffled.forEach((item, i) => {
          const img = document.createElement('img');
          img.src = `/api/images/${item.key}`;
          img.dataset.date = item.dateStr || formatDate(parseDate(item.key));
          img.dataset.captionKey = item.captionKey;
          img.dataset.index = i;
          img.loading = i < 3 ? 'eager' : 'lazy';
          if (i === 0) img.classList.add('active');
          gallery.appendChild(img);
          images.push(img);
        });

        // Preload first few captions
        for (let i = 0; i < Math.min(3, imageData.length); i++) {
          loadCaption(imageData[i].captionKey);
        }

        updateUI();
        startRotation();
        startProgress();

      } catch (error) {
        document.getElementById('loading').textContent = 'Error loading gallery';
        console.error(error);
      }
    }

    async function loadCaption(captionKey) {
      if (captions[captionKey] !== undefined) return captions[captionKey];
      try {
        const res = await fetch(`/api/images/${captionKey}`);
        if (res.ok) {
          const text = await res.text();
          // Clean up the caption - take first line or first 200 chars
          let caption = text.trim().split('\n')[0];
          if (caption.length > 200) caption = caption.substring(0, 200) + '...';
          captions[captionKey] = caption;
          return caption;
        }
      } catch (e) {}
      captions[captionKey] = null;
      return null;
    }

    function parseDate(filename) {
      const match = filename.match(/(\d{4})(\d{2})(\d{2})/);
      if (!match) return null;
      return new Date(match[1], parseInt(match[2]) - 1, match[3]);
    }

    function formatDate(date) {
      if (!date) return '';
      return date.toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric'
      });
    }

    async function updateUI() {
      document.getElementById('counter').textContent = `${current + 1} / ${images.length}`;
      document.getElementById('metaDate').textContent = images[current]?.dataset?.date || '';

      // Preload next caption
      const nextIdx = (current + 1) % imageData.length;
      if (imageData[nextIdx]) loadCaption(imageData[nextIdx].captionKey);

      // Update caption if visible
      if (captionVisible) {
        await showCaption();
      }
    }

    async function showCaption() {
      const captionKey = images[current]?.dataset?.captionKey;
      if (captionKey) {
        const caption = await loadCaption(captionKey);
        document.getElementById('captionText').textContent = caption || 'No caption available';
      }
    }

    function toggleCaption() {
      captionVisible = !captionVisible;
      const overlay = document.getElementById('captionOverlay');
      overlay.classList.toggle('visible', captionVisible);
      if (captionVisible) showCaption();
    }

    function rotate(direction = 1) {
      if (images.length === 0) return;
      images[current].classList.remove('active');
      current = (current + direction + images.length) % images.length;
      images[current].classList.add('active');
      updateUI();
      resetProgress();
    }

    function startRotation() {
      rotateInterval = setInterval(() => {
        if (!paused) rotate(1);
      }, ROTATE_TIME);
    }

    function startProgress() {
      let elapsed = 0;
      const bar = document.getElementById('progress');
      progressInterval = setInterval(() => {
        if (!paused) {
          elapsed += 50;
          bar.style.width = `${(elapsed / ROTATE_TIME) * 100}%`;
          if (elapsed >= ROTATE_TIME) elapsed = 0;
        }
      }, 50);
    }

    function resetProgress() {
      document.getElementById('progress').style.width = '0%';
    }

    function togglePause() {
      paused = !paused;
      const icon = document.getElementById('pauseIcon');
      if (paused) {
        icon.innerHTML = '<polygon points="5 3 19 12 5 21 5 3"/>';
      } else {
        icon.innerHTML = '<rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/>';
      }
    }

    // Controls
    document.getElementById('prev').addEventListener('click', () => rotate(-1));
    document.getElementById('next').addEventListener('click', () => rotate(1));
    document.getElementById('pause').addEventListener('click', togglePause);

    // Keyboard
    document.addEventListener('keydown', e => {
      if (e.key === 'ArrowLeft') rotate(-1);
      if (e.key === 'ArrowRight') rotate(1);
      if (e.key === ' ') { e.preventDefault(); togglePause(); }
      if (e.key === 'c' || e.key === 'C') toggleCaption();
      if (e.key === 'Escape') {
        if (captionVisible) toggleCaption();
        else if (infoPanel.classList.contains('open')) {
          infoPanel.classList.remove('open');
          infoToggle.classList.remove('active');
        }
      }
    });

    // Click on gallery to toggle caption
    document.getElementById('gallery').addEventListener('click', e => {
      if (e.target.tagName === 'IMG') {
        toggleCaption();
      }
    });

    // Touch swipe
    let touchStartX = 0;
    document.addEventListener('touchstart', e => {
      touchStartX = e.touches[0].clientX;
    }, { passive: true });
    document.addEventListener('touchend', e => {
      const diff = e.changedTouches[0].clientX - touchStartX;
      if (Math.abs(diff) > 50) {
        rotate(diff > 0 ? -1 : 1);
      }
    }, { passive: true });

    init();
  </script>
</body>
</html>
